# Define the script block
$scriptBlock = {
    param($ComputerName)

    # Get all shared folders
    $shares = Get-WmiObject -Class Win32_Share -ComputerName $ComputerName

    # Loop through each share
    foreach ($share in $shares) {
        Write-Host "Share Name: $($share.Name)"
        Write-Host "Path: $($share.Path)"
        Write-Host "Description: $($share.Description)"
        Write-Host "--------------------------------"

        # Get Share permissions using WMI (Win32_LogicalShareSecuritySetting)
        $sharePermissions = Get-WmiObject -Query "SELECT * FROM Win32_LogicalShareSecuritySetting WHERE Name = '$($share.Name)'" -ComputerName $ComputerName

        $accessList = $sharePermissions.GetSecurityDescriptor().Descriptor.DACL
        foreach ($access in $accessList) {
            $trustee = $access.Trustee.Name
            $accessMask = $access.AccessMask

            # Convert AccessMask to readable permissions
            $permissionsReadable = Switch ($accessMask) {
                2032127 { "Full Control" }
                1245631 { "Change" }
                1179817 { "Read" }
                Default { "Unknown" }
            }

            Write-Host "User/Group: $trustee"
            Write-Host "Permissions: $permissionsReadable"
            Write-Host "--------------------------------"
        }

        # Get NTFS permissions for the folder
        try {
            $acl = Get-Acl $share.Path
            $acl.Access | ForEach-Object {
                Write-Host "NTFS Permissions for $($_.IdentityReference): $($_.FileSystemRights)"
            }
        } catch {
            Write-Host "Failed to get NTFS permissions for path: $($share.Path)"
        }

        Write-Host "--------------------------------`n"
    }
}

# Invoke the script block with a target computer
Invoke-Command -ScriptBlock $scriptBlock -ArgumentList "localhost"
